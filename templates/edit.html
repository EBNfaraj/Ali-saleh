{% extends "layout.html" %}
{% block content %}

<div class="upload-container">
    <div class="upload-header">
        <h2><i class="fas fa-edit"></i> تعديل بيانات الفيديو</h2>
        <p>قم بتحديث عنوان، وصف، أو الكلمات المفتاحية للفيديو.</p>
    </div>
    
    <div class="upload-card">
        <form action="{{ url_for('edit_video', video_id=video.id) }}" method="POST" class="upload-form">
            
            <div class="form-group">
                <label for="title"><i class="fas fa-heading"></i> عنوان الفيديو</label>
                <input type="text" id="title" name="title" value="{{ video.title }}" class="form-control" required>
            </div>
            
            <div class="form-group">
                <label for="description"><i class="fas fa-align-left"></i> وصف الفيديو</label>
                <textarea id="description" name="description" class="form-control" rows="4" placeholder="أضف وصفاً للفيديو...">{{ video.description if video.description else '' }}</textarea>
            </div>
            
            <div class="form-group" style="position: relative;">
                <label for="content"><i class="fas fa-file-alt"></i> محتوى الفيديو</label>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <span id="transcription-status" style="font-size: 0.9em; color: var(--primary-color); display: none;">
                        <i class="fas fa-spinner fa-spin"></i> يتم التفريغ الآن...
                    </span>
                    <button type="button" id="start-transcription-btn" class="btn-secondary" style="background-color: #2c3e50; font-size: 0.9em; padding: 5px 10px;" onclick="startTranscription()">
                        <i class="fas fa-microphone-alt"></i> تفريغ النص بالذكاء الاصطناعي
                    </button>
                </div>
                
                <textarea id="content" name="content" class="form-control" rows="8" placeholder="محتوى أو تفاصيل الفيديو...">{{ video.content if video.content else '' }}</textarea>
            </div>
            
            <div class="form-group">
                <label for="tags"><i class="fas fa-tags"></i> كلمات مفتاحية (Tags)</label>
                <input type="text" id="tags" name="tags" value="{{ video.tags if video.tags else '' }}" placeholder="مثال: استرخاء, طبيعة, دراسة" class="form-control">
                <small class="form-text text-muted">افصل بين الكلمات بفاصلة ( , ).</small>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn-primary btn-block btn-lg"><i class="fas fa-save"></i> حفظ التعديلات</button>
                <a href="{{ url_for('watch_video', video_id=video.id) }}" class="btn-secondary btn-block mt-2" style="text-align: center;">إلغاء</a>
            </div>
        </form>
    </div>
</div>

<script>
function startTranscription() {
    const btn = document.getElementById('start-transcription-btn');
    const statusText = document.getElementById('transcription-status');
    const contentBox = document.getElementById('content');
    
    // UI Update
    btn.style.display = 'none';
    statusText.style.display = 'inline-block';
    
    // Clear content box if user agrees
    if(contentBox.value.trim() !== '') {
        if(!confirm('محتوى الفيديو الحالي سيتم استبداله مؤقتاً بالجديد. هل تريد المتابعة؟')) {
            btn.style.display = 'inline-block';
            statusText.style.display = 'none';
            return;
        }
    }
    contentBox.value = '';
    
    // Start EventSource
    const source = new EventSource("{{ url_for('transcribe_video_stream', video_id=video.id) }}");
    
    source.onmessage = function(event) {
        const data = JSON.parse(event.data);
        
        if (data.status === 'info') {
            statusText.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${data.message}`;
        } 
        else if (data.status === 'text') {
            statusText.innerHTML = `<i class="fas fa-spinner fa-spin"></i> جاري سحب الكلام واستخراجه...`;
            // Append new text directly to the textarea
            contentBox.value += data.text;
            // Auto scroll to bottom
            contentBox.scrollTop = contentBox.scrollHeight;
        }
        else if (data.status === 'done') {
            source.close();
            statusText.innerHTML = `<i class="fas fa-check-circle" style="color: #2ecc71;"></i> اكتمل التفريغ بنجاح! يتم الآن الحفظ...`;
            
            // Save automatically to backend
            fetch("{{ url_for('save_transcription', video_id=video.id) }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ content: data.full_text })
            }).then(resp => {
                setTimeout(() => {
                    btn.style.display = 'inline-block';
                    btn.innerHTML = '<i class="fas fa-redo"></i> إعادة التفريغ';
                    statusText.style.display = 'none';
                }, 3000);
            });
        }
        else if (data.status === 'error') {
            source.close();
            statusText.innerHTML = `<i class="fas fa-exclamation-triangle" style="color: #e74c3c;"></i> خطأ: ${data.message}`;
            btn.style.display = 'inline-block';
        }
    };
    
    source.onerror = function() {
        source.close();
        statusText.innerHTML = `<i class="fas fa-exclamation-triangle" style="color: #e74c3c;"></i> انقطع الاتصال بالسيرفر!`;
        btn.style.display = 'inline-block';
    };
}
</script>
            
            <div class="form-group">
                <label for="tags"><i class="fas fa-tags"></i> كلمات مفتاحية (Tags)</label>
                <input type="text" id="tags" name="tags" value="{{ video.tags if video.tags else '' }}" placeholder="مثال: استرخاء, طبيعة, دراسة" class="form-control">
                <small class="form-text text-muted">افصل بين الكلمات بفاصلة ( , ).</small>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn-primary btn-block btn-lg"><i class="fas fa-save"></i> حفظ التعديلات</button>
                <a href="{{ url_for('watch_video', video_id=video.id) }}" class="btn-secondary btn-block mt-2" style="text-align: center;">إلغاء</a>
            </div>
        </form>
    </div>
</div>

{% endblock %}
