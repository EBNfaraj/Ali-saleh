{% extends "layout.html" %}
{% block content %}

<div class="upload-container">
    <div class="upload-header">
        <h2><i class="fas fa-cloud-upload-alt"></i> رفع فيديو جديد</h2>
        <p>شارك فيديوهاتك المفضلة وأضف لها عنواناً وكلمات مفتاحية ليسهل البحث عنها.</p>
    </div>
    
    <div class="upload-card">
        <form action="{{ url_for('upload_video') }}" method="POST" enctype="multipart/form-data" class="upload-form">
            
            <div class="form-group file-upload-group">
                <div id="drop-zone" class="file-label file-drop-zone">
                    <i class="fas fa-file-video upload-icon"></i>
                    <span class="file-text">اسحب وأفلت الفيديو هنا أو اضغط للاختيار</span>
                    <span class="file-hint">(الصيغ المدعومة: MP4, WEBM)</span>
                    <input type="file" id="video_file" name="video_file" accept=".mp4,.webm" required class="file-input" onchange="updateFileName(this)">
                </div>
                <div id="file-name-display" class="file-name-display"></div>
            </div>
            
            <div class="form-group">
                <label for="title"><i class="fas fa-heading"></i> عنوان الفيديو (اختياري)</label>
                <input type="text" id="title" name="title" placeholder="إذا تركته فارغاً سيتم استخدام اسم الملف الأصلي" class="form-control">
            </div>
            
            <div class="form-group">
                <label for="description"><i class="fas fa-align-left"></i> وصف الفيديو (اختياري)</label>
                <textarea id="description" name="description" placeholder="اكتب وصفاً مختصراً للفيديو..." class="form-control" rows="3"></textarea>
            </div>
            
            <div class="form-group" style="position: relative;">
                <label for="content"><i class="fas fa-file-alt"></i> محتوى الفيديو (اختياري)</label>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <span id="transcription-status" style="font-size: 0.9em; color: var(--primary-color); display: none;">
                        <i class="fas fa-spinner fa-spin"></i> يتم التفريغ الآن...
                    </span>
                    <button type="button" id="start-transcription-btn" class="btn-secondary" style="background-color: #2c3e50; font-size: 0.9em; padding: 5px 10px;" onclick="uploadAndTranscribe()">
                        <i class="fas fa-microphone-alt"></i> تفريغ النص بالذكاء الاصطناعي الآن
                    </button>
                </div>

                <textarea id="content" name="content" placeholder="اكتب محتوى الفيديو أو تفاصيله هنا... سيتم تعبئته تلقائياً إذا استخدمت أداة التفريغ." class="form-control" rows="5"></textarea>
            </div>
            
            <div class="form-group">
                <label for="tags"><i class="fas fa-tags"></i> كلمات مفتاحية (Tags)</label>
                <input type="text" id="tags" name="tags" placeholder="مثال: استرخاء, طبيعة, دراسة, موسيقى (افصل بينها بفاصلة ,)" class="form-control">
                <small class="form-text text-muted">الكلمات المفتاحية تساعد الآخرين في العثور على الفيديو بسهولة.</small>
            </div>
            
            <div class="form-group" style="margin-top: 20px;">
                <label for="playlist_id"><i class="fas fa-list-ul"></i> إضافة إلى قائمة تشغيل (اختياري)</label>
                <select name="playlist_id" id="playlist_id" class="form-control" style="background: var(--card-bg);">
                    <option value="" selected>-- لا تضف إلى قائمة (مكتبة عامة) --</option>
                    {% for playlist in playlists %}
                    <option value="{{ playlist.id }}">{{ playlist.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn-primary btn-block btn-lg" id="submit-btn" onclick="showLoading()"><i class="fas fa-upload"></i> حفظ ورفع الفيديو كاملاً</button>
                <a href="{{ url_for('index') }}" class="btn-secondary btn-block mt-2" style="text-align: center;">إلغاء</a>
            </div>
        </form>
    </div>
</div>

<!-- Loading Overlay for Video Save -->
<div id="loading-overlay" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 3000; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(5px);">
    <i class="fas fa-spinner fa-spin" style="font-size: 4rem; color: var(--primary-color); margin-bottom: 20px;"></i>
    <h3 style="color: white; margin-bottom: 10px;">جاري حفظ الفيديو...</h3>
    <p style="color: #bbb; text-align: center; max-width: 400px; padding: 0 20px;">يتم الآن حفظ الفيديو في النظام. الرجاء الانتظار.</p>
</div>

<script>
function showLoading() {
    if (document.getElementById('video_file').files.length > 0) {
        document.getElementById('loading-overlay').style.display = 'flex';
    }
}

async function uploadAndTranscribe() {
    const fileInput = document.getElementById('video_file');
    const btn = document.getElementById('start-transcription-btn');
    const statusText = document.getElementById('transcription-status');
    const contentBox = document.getElementById('content');

    if (fileInput.files.length === 0) {
        alert("يرجى اختيار فيديو أولاً قبل بدء التفريغ!");
        return;
    }

    const file = fileInput.files[0];

    // UI Update
    btn.style.display = 'none';
    statusText.style.display = 'inline-block';
    statusText.innerHTML = `<i class="fas fa-spinner fa-spin"></i> جاري إرسال الفيديو المؤقت للتفريغ...`;
    contentBox.value = '';

    const formData = new FormData();
    formData.append('video_file', file);

    try {
        const response = await fetch("{{ url_for('transcribe_temp_stream') }}", {
            method: 'POST',
            body: formData
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder('utf-8');

        while (true) {
            const { value, done } = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value, { stream: true });
            const lines = chunk.split('\n');

            for (const line of lines) {
                if (line.startsWith('data: ')) {
                    const dataStr = line.substring(6).trim();
                    if (!dataStr) continue;

                    try {
                        const data = JSON.parse(dataStr);

                        if (data.status === 'info') {
                            statusText.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${data.message}`;
                        } 
                        else if (data.status === 'progress') {
                            statusText.innerHTML = `<i class="fas fa-spinner fa-spin"></i> جاري التفريغ النصي... (${data.progress}%)`;
                            contentBox.value += data.text;
                            contentBox.scrollTop = contentBox.scrollHeight;
                        }
                        else if (data.status === 'done') {
                            statusText.innerHTML = `<i class="fas fa-check-circle" style="color: #2ecc71;"></i> اكتمل التفريغ بنجاح! يمكنك الآن المتابعة لرفع الفيديو.`;
                            btn.style.display = 'inline-block';
                            btn.innerHTML = '<i class="fas fa-redo"></i> إعادة التفريغ';
                            setTimeout(() => { statusText.style.display = 'none'; }, 4000);
                        }
                        else if (data.status === 'error') {
                            statusText.innerHTML = `<i class="fas fa-exclamation-triangle" style="color: #e74c3c;"></i> خطأ: ${data.message}`;
                            btn.style.display = 'inline-block';
                        }
                    } catch (e) {
                        console.error('Error parsing SSE data:', e, dataStr);
                    }
                }
            }
        }
    } catch (error) {
        console.error('Transcription error:', error);
        statusText.innerHTML = `<i class="fas fa-exclamation-triangle" style="color: #e74c3c;"></i> حدث خطأ أثناء الاتصال.`;
        btn.style.display = 'inline-block';
    }
}
</script>

<script>
const dropZone = document.getElementById('drop-zone');
const fileInput = document.getElementById('video_file');
const display = document.getElementById('file-name-display');
const labelText = document.querySelector('.file-text');

// Prevent default drag behaviors
['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, preventDefaults, false);
    document.body.addEventListener(eventName, preventDefaults, false);
});

function preventDefaults (e) {
    e.preventDefault();
    e.stopPropagation();
}

// Highlight drop zone when item is dragged over it
['dragenter', 'dragover'].forEach(eventName => {
    dropZone.addEventListener(eventName, highlight, false);
});

['dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, unhighlight, false);
});

function highlight(e) {
    dropZone.classList.add('dragover');
}

function unhighlight(e) {
    dropZone.classList.remove('dragover');
}

// Handle dropped files
dropZone.addEventListener('drop', handleDrop, false);

function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    handleFiles(files);
}

dropZone.addEventListener('click', () => fileInput.click());

function updateFileName(input) {
    if (input.files && input.files.length > 0) {
        handleFiles(input.files);
    }
}

function handleFiles(files) {
    if (files.length > 0) {
        const file = files[0];
        // Check if file is video
        if (file.type.startsWith('video/') || file.name.endsWith('.mp4') || file.name.endsWith('.webm')) {
            // Assign file to input
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            fileInput.files = dataTransfer.files;
            
            display.textContent = 'الملف المحدد: ' + file.name;
            display.style.display = 'block';
            labelText.textContent = 'تغيير الملف';
        } else {
            alert('الرجاء اختيار ملف فيديو بصيغة (MP4, WEBM) فقط.');
            fileInput.value = '';
            display.style.display = 'none';
        }
    }
}
</script>

{% endblock %}
